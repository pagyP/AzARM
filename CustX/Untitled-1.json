{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "environmentName": {
      "type": "string",
      "metadata": {
        "description": "Name of the environnment the resources are for"
      }
    },
    "paloAltoAdminName": {
      "type": "string",
      "metadata": {
        "description": "The name of the privileged account that should be used to ssh and login to the PanOS web portal."
      }
    },
    "paloAltoAdminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Password to the privileged account used to ssh and login to the PanOS web portal."
      }
    },
    "vpnSharedKey": {
      "type": "securestring",
      "metadata": {
        "description": "Shared Key for the VPN connection"
      }
    }
  },
  "variables": {

    "environmentNameLower": "[toLower(parameters('environmentName'))]",

    // Tier1 Hub subnet
    "virtualNetworkNameTier1Hub": "bcprdvnthubv001",
    "virtualNetworkIdTier1Hub": "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworkNameTier1Hub'))]",
    "virtualNetworkTier1HubAddressPrefix": "10.60.0.0/16",

    // Gateway + DC's + Firewall (NVA's) subnets
    "tier1gwSubnetName": "GatewaySubnet",
    "tier1gwSubnetPrefix": "10.60.0.0/26",
    "tier1gwSubnetRef": "[resourceId('Microsoft.Network/virtualNetworks/subnets/', variables('virtualNetworkNameTier1Hub'), variables('tier1gwSubnetName'))]",
    "tier1gwSubnetRouteTable": "GatewaySubnet-rtb",
    "tier1dsSubnetName": "bcprdsubdcxn001-10.60.0.64_26",
    "tier1dsSubnetPrefix": "10.60.0.64/26",
    "tier1dsSubnetRef": "[resourceId('Microsoft.Network/virtualNetworks/subnets/', variables('virtualNetworkNameTier1Hub'), variables('tier1dsSubnetName'))]",
    "tier1dsSubnetRouteTable": "bcprdrtbdcxn001",
    "tier1fwmgmtSubnetName": "bcprdsubfwxn001-10.60.1.0_24-management",
    "tier1fwmgmtSubnetPrefix": "10.60.1.0/24",
    "tier1fwmgmtPrefix": "10.60.1.",
    "tier1fwmgmtIPfirst": 4,
    "tier1fwmgmtSubnetRef": "[resourceId('Microsoft.Network/virtualNetworks/subnets/', variables('virtualNetworkNameTier1Hub'), variables('tier1fwmgmtSubnetName'))]",
    "tier1fwtrustSubnetName": "bcprdsubfwxn002-10.60.2.0_24-trust",
    "tier1fwtrustSubnetPrefix": "10.60.2.0/24",
    "tier1fwtrustPrefix": "10.60.2.",
    "tier1fwtrustIPfirst": 4,
    "tier1fwtrustSubnetStartAddress": "10.60.2.4",
    "tier1fwtrustSubnetRef": "[resourceId('Microsoft.Network/virtualNetworks/subnets/', variables('virtualNetworkNameTier1Hub'), variables('tier1fwtrustSubnetName'))]",
    "tier1fwtrustRouteTable": "bcprdrtbfwxn002",
    "tier1fwuntrustSubnetName": "bcprdsubfwxn003-10.60.3.0_24-untrust",
    "tier1fwuntrustSubnetPrefix": "10.60.3.0/24",
    "tier1fwuntrustPrefix": "10.60.3.",
    "tier1fwuntrustIPfirst": 4,
    "tier1fwuntrustSubnetStartAddress": "10.60.3.4",
    "tier1fwuntrustSubnetRef": "[resourceId('Microsoft.Network/virtualNetworks/subnets/', variables('virtualNetworkNameTier1Hub'), variables('tier1fwuntrustSubnetName'))]",
    "tier1fwbkhaulSubnetName": "bcprdsubfwxn004-10.60.4.0_24-bkhaul",
    "tier1fwbkhaulSubnetPrefix": "10.60.4.0/24",
    "tier1fwbkhaulPrefix": "10.60.4.",
    "tier1fwbkhaulIPfirst": 4,
    "tier1fwbkhaulSubnetStartAddress": "10.60.4.4",
    "tier1fwbkhaulSubnetRef": "[resourceId('Microsoft.Network/virtualNetworks/subnets/', variables('virtualNetworkNameTier1Hub'), variables('tier1fwbkhaulSubnetName'))]",

    // Production subnets
    "prodNetworkName": "bcprdvntnetv001",
    "prodNetworkId": "[resourceId('Microsoft.Network/virtualNetworks', variables('prodNetworkName'))]",
    "prodNetworkAddressPrefix": "10.61.0.0/16",

    // Secure Spoke variables
    "secureSpokeName": "bcprdvntsecv001",
    "secureSpokeNetworkId": "[resourceId('Microsoft.Network/virtualNetworks', variables('secureSpokeName'))]",
    "secureSpokeAddressPrefix": "10.63.0.0/16",

    // Web Spoke variables
    "webSpokeName": "bcprdvntwebv001",
    "webSpokeNetworkId": "[resourceId('Microsoft.Network/virtualNetworks', variables('webSpokeName'))]",
    "webSpokeAddressPrefix": "10.64.0.0/16",

    // Applications subnets
    "sub1SubnetName": "bcprdsubclkn001-10.61.0.0_27",
    "sub1SubnetPrefix": "10.61.0.0/27",
    "sub1SubnetRef": "[resourceId('Microsoft.Network/virtualNetworks/subnets/', variables('prodNetworkName'), variables('sub1SubnetName'))]",
    "sub1SubnetRouteTable": "bcprdrtbclkn001",
    "sub2SubnetName": "bcprdsubaxmn001-10.61.0.32_28",
    "sub2SubnetPrefix": "10.61.0.32/28",
    "sub2SubnetRef": "[resourceId('Microsoft.Network/virtualNetworks/subnets/', variables('prodNetworkName'), variables('sub2SubnetName'))]",
    "sub2SubnetRouteTable": "bcprdrtbaxmn001",
    "sub3SubnetName": "bcprdsubbirn001-10.61.0.48_28",
    "sub3SubnetPrefix": "10.61.0.48/28",
    "sub3SubnetRef": "[resourceId('Microsoft.Network/virtualNetworks/subnets/', variables('prodNetworkName'), variables('sub3SubnetName'))]",
    "sub3SubnetRouteTable": "bcprdrtbbirn001",
    "sub4SubnetName": "bcprdsubcaln001-10.61.0.64_28",
    "sub4SubnetPrefix": "10.61.0.64/28",
    "sub4SubnetRef": "[resourceId('Microsoft.Network/virtualNetworks/subnets/', variables('prodNetworkName'), variables('sub4SubnetName'))]",
    "sub4SubnetRouteTable": "bcprdrtbcaln001",
    "sub5SubnetName": "bcprdsubiawn001-10.61.0.80_28",
    "sub5SubnetPrefix": "10.61.0.80/28",
    "sub5SubnetRef": "[resourceId('Microsoft.Network/virtualNetworks/subnets/', variables('prodNetworkName'), variables('sub5SubnetName'))]",
    "sub5SubnetRouteTable": "bcprdrtbiawn001",

    // Production Azure Bastion Subnet
    "prdBastionSubnetName": "AzureBastionSubnet",
    "prdBastionSubnetPrefix": "10.61.99.0/24",
    "prdBastionSubnetRef": "[resourceId('Microsoft.Network/virtualNetworks/subnets/', variables('prodNetworkName'), variables('prdBastionSubnetName'))]",

    // Hub Azure Bastion Subnet
    "hubBastionSubnetName": "AzureBastionSubnet",
    "hubBastionSubnetPrefix": "10.60.99.0/24",
    "hubBastionSubnetRef": "[resourceId('Microsoft.Network/virtualNetworks/subnets/', variables('virtualNetworkNameTier1Hub'), variables('hubBastionSubnetName'))]",

    // Secure Spoke Subnets
    "secBastionSubnetName": "AzureBastionSubnet",
    "secBastionSubnetPrefix": "10.63.99.0/24",
    "secBastionSubnetRef": "[resourceId('Microsoft.Network/virtualNetworks/subnets/', variables('secureSpokeName'), variables('secBastionSubnetName'))]",
    "secsub1SubnetName": "bcprdsubclkn002-10.63.0.0_27",
    "secsub1SubnetPrefix": "10.63.0.0/27",
    "secsub1SubnetRef": "[resourceId('Microsoft.Network/virtualNetworks/subnets/', variables('secureSpokeName'), variables('secsub1SubnetName'))]",
    "secsub1SubnetRouteTable": "bcprdrtbclkn002",

    // Web Spoke Azure Bastion Subnet
    "webBastionSubnetName": "AzureBastionSubnet",
    "webBastionSubnetPrefix": "10.64.99.0/24",
    "webBastionSubnetRef": "[resourceId('Microsoft.Network/virtualNetworks/subnets/', variables('webSpokeName'), variables('webBastionSubnetName'))]",
    "websub1SubnetName": "bcprdsubcorn001-10.64.0.0_28",
    "websub1SubnetPrefix": "10.64.0.0/28",
    "websub1SubnetRef": "[resourceId('Microsoft.Network/virtualNetworks/subnets/', variables('webSpokeName'), variables('websub1SubnetName'))]",
    "websub1SubnetRouteTable": "bcprdrtbcorn001",

    // Palo Alto vm series
    "fwNamePrefix": "bcprdnvafwxn00",
    "panPublicIPName": "[concat(variables('fwNamePrefix'), '-pip-management')]",
    "panfwPublicIPDnsName": "[concat('bcc-', variables('environmentNameLower'), '-fw-pip')]",
    "nicName": "[concat(variables('fwNamePrefix'), '-nic')]",
    "vmSize": "Standard_DS3_v2",
    //"PASku": "byol",
    "PASku": "bundle2",
    //"PAVersion": "latest",
    "PAVersion": "9.0.4",
    "PACount": 2,

    "uniqueId": "[uniqueString(resourceGroup().id)]",
    "availabilitySetName": "bcdevavsfwxn001",
    "untrustLBName": "bcprdelbfwxn001",
    "fwILBName": "bcprdilbfwxn001",

    // Express Route Gateway
    "erGatewayName": "bcprdngwexrv002",
    "erGatewayType": "ExpressRoute",
    "erConnectionName": "bcprdconexrn002-expressroute-uksouth",
    "erConnectionType": "ExpressRoute",
    "erGatewayPublicIPName": "bcprdngwexrv002-pip",
    "erGatewayPublicIP": "",
    "erCircuitName": "bcprdexrxxxx002",
    "erServiceProvider": "Jisc",
    "erPeeringLocation": "London",
    "erBandwidth": "1000",
    "erSkuTier": "Standard",
    "erSkuFamily": "MeteredData",
    "routingWeight": 3,

    // VPN Gateway
    "vpntype": "RouteBased",
    "vpnGatewayName": "bcprdngwvpnv001",
    "vpnGatewayType": "Vpn",
    "vpnConnectionName": "bcprdconvpnn001-vpn-uksouth",
    "vpnConnectionType": "IPsec",
    "vpnGatewayPublicIPName": "brprdvpnngwv001-pip",
    "vpnGatwayPublicIP": "",
    "vpnGatewaySku": "VpnGw2",


    // Local Gateway
    "localGatewayName": "brprdlgwlocn001",
    "localGatewayIPAddress": "193.35.234.23",
    "localAddressPrefixes": [
      "10.0.0.0/8",
      "172.16.0.0/12",
      "196.168.0.0/16"

    ]

  },


  "resources": [
    {
      "apiVersion": "2018-02-01",
      "name": "pid-adb8eac6-989a-5354-8580-19055546ec74",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "resources": []
        }
      }
    },

    // Network Security Groups
    {
      "apiVersion": "2018-11-01",
      "type": "Microsoft.Network/networkSecurityGroups",
      "name": "bcprdnsgclka001",
      "location": "[resourceGroup().location]",
      "tags": {
        "Environment": "Production",
        "Application": "ClickMobile",
        "Function": "Networking",
        "Application Owner": "Zara Naylor",
        "Directorate": "City Growth, Investment and Infrastructure including Culture",
        "Cost Centre": "11302"
      },
      "properties": {
        "securityRules": [
          {
            "name": "bcprdnsgclka001-rule-inbound-deny-all",
            "properties": {
              "access": "Deny",
              "destinationAddressPrefix": "*",
              "destinationPortRange": "*",
              "direction": "Inbound",
              "priority": 4095,
              "protocol": "*",
              "sourceAddressPrefix": "*",
              "sourcePortRange": "*",
              "description": "block all traffic except what we've explicitly allowed"
            }
          },
          {
            "name": "bcprdnsgclka001-rule-inbound-allow-rdp",
            "properties": {
              "access": "Allow",
              "destinationAddressPrefix": "*",
              "destinationPortRange": "3389-4500",
              "direction": "Inbound",
              "priority": 3960,
              "protocol": "*",
              "sourceAddressPrefix": "*",
              "sourcePortRange": "*",
              "description": "allow RDP access to the clickmobile subnet"

            }
          }
        ]
      }
    },
    {
      "apiVersion": "2018-11-01",
      "type": "Microsoft.Network/networkSecurityGroups",
      "name": "bcprdnsgaxma001",
      "location": "[resourceGroup().location]",
      "tags": {
        "Environment": "Production",
        "Application": "Axiom",
        "Function": "Networking",
        "Application Owner": "Gemma Hilton",
        "Directorate": "Commercialisation",
        "Cost Centre": "11302"
      },
      "properties": {
        "securityRules": [
          {
            "name": "bcprdnsgaxma001-rule-inbound-deny-all",
            "properties": {
              "access": "Deny",
              "destinationAddressPrefix": "*",
              "destinationPortRange": "*",
              "direction": "Inbound",
              "priority": 4095,
              "protocol": "*",
              "sourceAddressPrefix": "*",
              "sourcePortRange": "*",
              "description": "block all traffic except what we've explicitly allowed"
            }
          },
          {
            "name": "bcprdnsgaxma001-rule-inbound-allow-rdp",
            "properties": {
              "access": "Allow",
              "destinationAddressPrefix": "*",
              "destinationPortRange": "3389-4500",
              "direction": "Inbound",
              "priority": 3960,
              "protocol": "*",
              "sourceAddressPrefix": "*",
              "sourcePortRange": "*",
              "description": "allow RDP access to the axiom subnet"

            }
          }
        ]
      }
    },

    {
      "apiVersion": "2018-11-01",
      "type": "Microsoft.Network/networkSecurityGroups",
      "name": "bcprdnsgbira001",
      "location": "[resourceGroup().location]",
      "dependsOn": [],
      "tags": {
        "Environment": "Production",
        "Application": "BI Reports",
        "Function": "Networking",
        "Application Owner": "Paul Horton",
        "Directorate": "Policy, Strategy and ICT",
        "Cost Centre": "11302"
      },
      "properties": {
        "securityRules": [
          {
            "name": "bcprdnsgbira001-rule-inbound-deny-all",
            "properties": {
              "access": "Deny",
              "destinationAddressPrefix": "*",
              "destinationPortRange": "*",
              "direction": "Inbound",
              "priority": 4095,
              "protocol": "*",
              "sourceAddressPrefix": "*",
              "sourcePortRange": "*",
              "description": "block all traffic except what we've explicitly allowed"
            }
          },
          {
            "name": "bcprdnsgbira001-rule-inbound-allow-rdp",
            "properties": {
              "access": "Allow",
              "destinationAddressPrefix": "*",
              "destinationPortRange": "3389-4500",
              "direction": "Inbound",
              "priority": 3960,
              "protocol": "*",
              "sourceAddressPrefix": "*",
              "sourcePortRange": "*",
              "description": "allow RDP access to the bi reports subnet"

            }
          }
        ]
      }
    },

    {
      "apiVersion": "2018-11-01",
      "type": "Microsoft.Network/networkSecurityGroups",
      "name": "bcprdnsgcala001",
      "location": "[resourceGroup().location]",
      "tags": {
        "Environment": "Production",
        "Application": "CalmView",
        "Function": "Networking",
        "Application Owner": "Malcolm Boyns",
        "Directorate": "City Growth, Investment and Infrastructure including Culture",
        "Cost Centre": "11302"
      },
      "properties": {
        "securityRules": [
          {
            "name": "bcprdnsgcala001-rule-inbound-deny-all",
            "properties": {
              "access": "Deny",
              "destinationAddressPrefix": "*",
              "destinationPortRange": "*",
              "direction": "Inbound",
              "priority": 4095,
              "protocol": "*",
              "sourceAddressPrefix": "*",
              "sourcePortRange": "*",
              "description": "block all traffic except what we've explicitly allowed"
            }
          },
          {
            "name": "bcprdnsgcala001-rule-inbound-allow-rdp",
            "properties": {
              "access": "Allow",
              "destinationAddressPrefix": "*",
              "destinationPortRange": "3389-4500",
              "direction": "Inbound",
              "priority": 3960,
              "protocol": "*",
              "sourceAddressPrefix": "*",
              "sourcePortRange": "*",
              "description": "allow RDP access to the calm view subnet"

            }
          }
        ]
      }
    },
    {
      "apiVersion": "2018-11-01",
      "type": "Microsoft.Network/networkSecurityGroups",
      "name": "bcprdnsgiawa001",
      "location": "[resourceGroup().location]",
      "dependsOn": [],
      "tags": {
        "Environment": "Production",
        "Application": "Information@Work",
        "Function": "Networking",
        "Application Owner": "Kevin Smith",
        "Directorate": "Finance",
        "Cost Centre": "11302"
      },
      "properties": {
        "securityRules": [
          {
            "name": "bcprdnsgiawa001-rule-inbound-deny-all",
            "properties": {
              "access": "Deny",
              "destinationAddressPrefix": "*",
              "destinationPortRange": "*",
              "direction": "Inbound",
              "priority": 4095,
              "protocol": "*",
              "sourceAddressPrefix": "*",
              "sourcePortRange": "*",
              "description": "block all traffic except what we've explicitly allowed"
            }
          },
          {
            "name": "bcprdnsgiawa001-rule-inbound-allow-rdp",
            "properties": {
              "access": "Allow",
              "destinationAddressPrefix": "*",
              "destinationPortRange": "3389-4500",
              "direction": "Inbound",
              "priority": 3960,
              "protocol": "*",
              "sourceAddressPrefix": "*",
              "sourcePortRange": "*",
              "description": "allow RDP access to the information@work subnet"

            }
          }
        ]
      }
    },
    {
      "apiVersion": "2018-11-01",
      "type": "Microsoft.Network/networkSecurityGroups",
      "name": "bcprdnsgdcxx001",
      "location": "[resourceGroup().location]",
      "tags": {
        "Environment": "Production",
        "Application": "Domain Services",
        "Function": "Networking",
        "Application Owner": "Tim Farrance",
        "Directorate": "Policy, Strategy and ICT",
        "Cost Centre": "11302"
      },
      "properties": {
        "securityRules": [
          {
            "name": "bcprdnsgdcxx001-rule-inbound-deny-all",
            "properties": {
              "access": "Deny",
              "destinationAddressPrefix": "*",
              "destinationPortRange": "*",
              "direction": "Inbound",
              "priority": 4095,
              "protocol": "*",
              "sourceAddressPrefix": "*",
              "sourcePortRange": "*",
              "description": "block all traffic except what we've explicitly allowed"
            }
          },
          {
            "name": "bcprdnsgdcxx001-rule-inbound-allow-rdp",
            "properties": {
              "access": "Allow",
              "destinationAddressPrefix": "*",
              "destinationPortRange": "3389-4500",
              "direction": "Inbound",
              "priority": 3960,
              "protocol": "*",
              "sourceAddressPrefix": "*",
              "sourcePortRange": "*",
              "description": "allow RDP access to the tier1 ds subnet"

            }
          }
        ]
      }
    },
    {
      "apiVersion": "2018-11-01",
      "type": "Microsoft.Network/networkSecurityGroups",
      "name": "bcprdnsgfwxx001",
      "location": "[resourceGroup().location]",
      "tags": {
        "Environment": "Production",
        "Application": "NVA - Firewall",
        "Function": "Networking",
        "Application Owner": "Tim Farrance",
        "Directorate": "Policy, Strategy and ICT",
        "Cost Centre": "11302"
      },
      "properties": {
        "securityRules": [
          {
            "name": "bcprdnsgfwxx001-rule-inbound-allow-ssh",
            "properties": {
              "description": "Allow SSH access to Palo Management Interface",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "22",
              "sourceAddressPrefixes": [
                "193.35.234.68/32",
                "193.35.234.102/32"
              ],
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 100,
              "direction": "Inbound"
            }
          },
          {
            "name": "bcprdnsgfwxx001-rule-inbound-allow-https",
            "properties": {
              "description": "Allow HTTPS access to Palo Management Interface",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "443",
              "sourceAddressPrefixes": [
                "193.35.234.68/32",
                "193.35.234.102/32"
              ],
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 101,
              "direction": "Inbound"
            }
          }
        ]
      }
    },

    // Production VNET
    {
      "type": "Microsoft.Network/virtualNetworks",
      "name": "[variables('prodNetworkName')]",
      "apiVersion": "2018-08-01",
      "location": "[resourceGroup().location]",
      "tags": {
        "Environment": "Production",
        "Application": "Azure VNET",
        "Function": "Networking",
        "Application Owner": "Tim Farrance",
        "Directorate": "Policy, Strategy and ICT",
        "Cost Centre": "11302"
      },
      // If dependency is not set then it will fail to deploy as the API executes random the code
      "dependsOn": [
        "[concat('Microsoft.Network/networkSecurityGroups/', 'bcprdnsgclka001')]",
        "[concat('Microsoft.Network/networkSecurityGroups/', 'bcprdnsgaxma001')]",
        "[concat('Microsoft.Network/networkSecurityGroups/', 'bcprdnsgbira001')]",
        "[concat('Microsoft.Network/networkSecurityGroups/', 'bcprdnsgcala001')]",
        "[concat('Microsoft.Network/networkSecurityGroups/', 'bcprdnsgiawa001')]"
      ],
      "properties": {
        "addressSpace": {
          "addressPrefixes": [
            "[variables('prodNetworkAddressPrefix')]"
          ]
        },
        "subnets": [
          {
            "name": "[variables('sub1SubnetName')]",
            "properties": {
              "addressPrefix": "[variables('sub1SubnetPrefix')]",
              "routeTable": {
                "id": "[resourceId('Microsoft.Network/routeTables', variables('sub1SubnetRouteTable'))]"
              },
              "networkSecurityGroup": {
                "id": "[resourceId('Microsoft.Network/networkSecurityGroups','bcprdnsgclka001')]"
              }
            }
          },
          {
            "name": "[variables('sub2SubnetName')]",
            "properties": {
              "addressPrefix": "[variables('sub2SubnetPrefix')]",
              "routeTable": {
                "id": "[resourceId('Microsoft.Network/routeTables', variables('sub2SubnetRouteTable'))]"
              },
              "networkSecurityGroup": {
                "id": "[resourceId('Microsoft.Network/networkSecurityGroups', 'bcprdnsgaxma001')]"
              }
            }
          },
          {
            "name": "[variables('sub3SubnetName')]",
            "properties": {
              "addressPrefix": "[variables('sub3SubnetPrefix')]",
              "routeTable": {
                "id": "[resourceId('Microsoft.Network/routeTables', variables('sub3SubnetRouteTable'))]"
              },
              "networkSecurityGroup": {
                "id": "[resourceId('Microsoft.Network/networkSecurityGroups', 'bcprdnsgbira001')]"
              }
            }
          },
          {
            "name": "[variables('sub4SubnetName')]",
            "properties": {
              "addressPrefix": "[variables('sub4SubnetPrefix')]",
              "routeTable": {
                "id": "[resourceId('Microsoft.Network/routeTables', variables('sub4SubnetRouteTable'))]"
              },
              "networkSecurityGroup": {
                "id": "[resourceId('Microsoft.Network/networkSecurityGroups', 'bcprdnsgcala001')]"
              }
            }
          },
          {
            "name": "[variables('sub5SubnetName')]",
            "properties": {
              "addressPrefix": "[variables('sub5SubnetPrefix')]",
              "routeTable": {
                "id": "[resourceId('Microsoft.Network/routeTables', variables('sub5SubnetRouteTable'))]"
              },
              "networkSecurityGroup": {
                "id": "[resourceId('Microsoft.Network/networkSecurityGroups', 'bcprdnsgiawa001')]"
              }
            }
          },
          {
            "name": "[variables('prdBastionSubnetName')]",
            "properties": {
              "addressPrefix": "[variables('prdBastionSubnetPrefix')]"
            }
          }
        ]
      }
    },

    // Tier1 Hub VNET
    {
      "type": "Microsoft.Network/virtualNetworks",
      "name": "[variables('virtualNetworkNameTier1Hub')]",
      "apiVersion": "2018-08-01",
      "location": "[resourceGroup().location]",
      "tags": {
        "Environment": "Production",
        "Application": "Azure VNET",
        "Function": "Networking",
        "Application Owner": "Tim Farrance",
        "Directorate": "Policy, Strategy and ICT",
        "Cost Centre": "11302"
      },
      "dependsOn": [
        "[concat('Microsoft.Network/networkSecurityGroups/', 'bcprdnsgdcxx001')]",
        "[concat('Microsoft.Network/networkSecurityGroups/', 'bcprdnsgfwxx001')]"
      ],
      "properties": {
        "addressSpace": {
          "addressPrefixes": [
            "[variables('virtualNetworkTier1HubAddressPrefix')]"
          ]
        },
        "subnets": [
          {
            "name": "[variables('tier1dsSubnetName')]",
            "properties": {
              "addressPrefix": "[variables('tier1dsSubnetPrefix')]",
              "routeTable": {
                "id": "[resourceId('Microsoft.Network/routeTables', variables('tier1dsSubnetRouteTable'))]"
              },
              "networkSecurityGroup": {
                "id": "[resourceId('Microsoft.Network/networkSecurityGroups', 'bcprdnsgdcxx001')]"
              }
            }
          },
          {
            "name": "[variables('tier1fwmgmtSubnetName')]",
            "properties": {
              "addressPrefix": "[variables('tier1fwmgmtSubnetPrefix')]",
              "networkSecurityGroup": {
                "id": "[resourceId('Microsoft.Network/networkSecurityGroups', 'bcprdnsgfwxx001')]"
              }
            }
          },
          {
            "name": "[variables('tier1fwtrustSubnetName')]",
            "properties": {
              "addressPrefix": "[variables('tier1fwtrustSubnetPrefix')]"
            }
          },
          {
            "name": "[variables('tier1fwuntrustSubnetName')]",
            "properties": {
              "addressPrefix": "[variables('tier1fwuntrustSubnetPrefix')]"
            }
          },
          {
            "name": "[variables('tier1fwbkhaulSubnetName')]",
            "properties": {
              "addressPrefix": "[variables('tier1fwbkhaulSubnetPrefix')]"
            }
          },
          {
            "name": "[variables('tier1gwSubnetName')]",
            "properties": {
              "addressPrefix": "[variables('tier1gwSubnetPrefix')]",
              "routeTable": {
                "id": "[resourceId('Microsoft.Network/routeTables', variables('tier1gwSubnetRouteTable'))]"
              }
            }
          },
          {
            "name": "[variables('hubBastionSubnetName')]",
            "properties": {
              "addressPrefix": "[variables('hubBastionSubnetPrefix')]"
            }
          }
        ]
      }
    },

    // Secure Spoke VNET
    {
      "type": "Microsoft.Network/virtualNetworks",
      "name": "[variables('secureSpokeName')]",
      "apiVersion": "2018-08-01",
      "location": "[resourceGroup().location]",
      "tags": {
        "Environment": "Production",
        "Application": "Azure VNET",
        "Function": "Networking",
        "Application Owner": "Tim Farrance",
        "Directorate": "Policy, Strategy and ICT",
        "Cost Centre": "11302"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/routeTables', variables('secsub1SubnetRouteTable'))]"
      ],
      "properties": {
        "addressSpace": {
          "addressPrefixes": [
            "[variables('secureSpokeAddressPrefix')]"
          ]
        },
        "subnets": [
          {
            "name": "[variables('secBastionSubnetName')]",
            "properties": {
              "addressPrefix": "[variables('secBastionSubnetPrefix')]"
            }
          },
          {
            "name": "[variables('secsub1SubnetName')]",
            "properties": {
              "addressPrefix": "[variables('secsub1SubnetPrefix')]",
              "routeTable": {
                "id": "[resourceId('Microsoft.Network/routeTables', variables('secsub1SubnetRouteTable'))]"
              }
            }
          }
        ]
      }
    },

    // Web Spoke VNET
    {
      "type": "Microsoft.Network/virtualNetworks",
      "name": "[variables('webSpokeName')]",
      "apiVersion": "2018-08-01",
      "location": "[resourceGroup().location]",
      "tags": {
        "Environment": "Production",
        "Application": "Azure VNET",
        "Function": "Networking",
        "Application Owner": "Tim Farrance",
        "Directorate": "Policy, Strategy and ICT",
        "Cost Centre": "11302"
      },
      "properties": {
        "addressSpace": {
          "addressPrefixes": [
            "[variables('webSpokeAddressPrefix')]"
          ]
        },
        "subnets": [
          {
            "name": "[variables('webBastionSubnetName')]",
            "properties": {
              "addressPrefix": "[variables('webBastionSubnetPrefix')]"
            }
          },
          {
            "name": "[variables('websub1SubnetName')]",
            "properties": {
              "addressPrefix": "[variables('websub1SubnetPrefix')]",
              "routeTable": {
                "id": "[resourceId('Microsoft.Network/routeTables', variables('websub1SubnetRouteTable'))]"
              }
            }
          }
        ]
      }
    },

    // Subnet Route Tables
    {
      "apiVersion": "2018-02-01",
      "type": "Microsoft.Network/routeTables",
      "name": "[variables('tier1fwtrustRouteTable')]",
      "location": "[resourceGroup().location]",
      "tags": {
        "Environment": "Production",
        "Application": "Azure VNET",
        "Function": "Networking",
        "Application Owner": "Tim Farrance",
        "Directorate": "Policy, Strategy and ICT",
        "Cost Centre": "11302"
      },
      "properties": {
        "routes": [
          {
            "name": "bcprdudrfwxn002-trust-to-azureinternalnetwork",
            "properties": {
              "addressPrefix": "0.0.0.0/0",
              "nextHopType": "VirtualAppliance",
              "nextHopIpAddress": "[variables('tier1fwtrustSubnetStartAddress')]"
            }
          }
        ]
      }
    },
    {
      "apiVersion": "2018-02-01",
      "type": "Microsoft.Network/routeTables",
      "name": "[variables('tier1dsSubnetRouteTable')]",
      "location": "[resourceGroup().location]",
      "tags": {
        "Environment": "Production",
        "Application": "Domain Services",
        "Function": "Networking",
        "Application Owner": "Tim Farrance",
        "Directorate": "Policy, Strategy and ICT",
        "Cost Centre": "11302"
      },
      "properties": {
        "routes": [
          {
            "name": "bcprdudrdcxn001-domain-services-to-azureinternalnetwork",
            "properties": {
              "addressPrefix": "0.0.0.0/0",
              "nextHopType": "VirtualAppliance",
              "nextHopIpAddress": "[variables('tier1fwtrustSubnetStartAddress')]"
            }
          }
        ]
      }
    },
    {
      "apiVersion": "2018-02-01",
      "type": "Microsoft.Network/routeTables",
      "name": "[variables('tier1gwSubnetRouteTable')]",
      "location": "[resourceGroup().location]",
      "tags": {
        "Environment": "Production",
        "Application": "Azure VNET",
        "Function": "Networking",
        "Application Owner": "Tim Farrance",
        "Directorate": "Policy, Strategy and ICT",
        "Cost Centre": "11302"
      },
      "properties": {
        "routes": [
          {
            "name": "gateway-to-production-udr",
            "properties": {
              "addressPrefix": "10.61.0.0/16",
              "nextHopType": "VirtualAppliance",
              "nextHopIpAddress": "[variables('tier1fwbkhaulSubnetStartAddress')]"
            }
          },
          {
            "name": "gateway-to-secure-udr",
            "properties": {
              "addressPrefix": "10.64.0.0/16",
              "nextHopType": "VirtualAppliance",
              "nextHopIpAddress": "[variables('tier1fwbkhaulSubnetStartAddress')]"
            }
          },
          {
            "name": "gateway-to-web-udr",
            "properties": {
              "addressPrefix": "10.63.0.0/16",
              "nextHopType": "VirtualAppliance",
              "nextHopIpAddress": "[variables('tier1fwbkhaulSubnetStartAddress')]"
            }
          }

        ]
      }
    },
    {
      "apiVersion": "2018-02-01",
      "type": "Microsoft.Network/routeTables",
      "name": "[variables('sub1SubnetRouteTable')]",
      "location": "[resourceGroup().location]",
      "tags": {
        "Environment": "Production",
        "Application": "Click Mobile",
        "Function": "Networking",
        "Application Owner": "Tim Farrance",
        "Directorate": "Policy, Strategy and ICT",
        "Cost Centre": "11302"
      },
      "properties": {
        "routes": [
          {
            "name": "bcprdudrclkn001-production-to-tier1hub",
            "properties": {
              "addressPrefix": "0.0.0.0/0",
              "nextHopType": "VirtualAppliance",
              "nextHopIpAddress": "[variables('tier1fwtrustSubnetStartAddress')]"
            }
          }
        ]
      }
    },
    {
      "apiVersion": "2018-02-01",
      "type": "Microsoft.Network/routeTables",
      "name": "[variables('sub2SubnetRouteTable')]",
      "location": "[resourceGroup().location]",
      "tags": {
        "Environment": "Production",
        "Application": "Axiom",
        "Function": "Networking",
        "Application Owner": "Tim Farrance",
        "Directorate": "Policy, Strategy and ICT",
        "Cost Centre": "11302"
      },
      "properties": {
        "routes": [
          {
            "name": "bcprdudraxmn001-production-to-tier1hub",
            "properties": {
              "addressPrefix": "0.0.0.0/0",
              "nextHopType": "VirtualAppliance",
              "nextHopIpAddress": "[variables('tier1fwtrustSubnetStartAddress')]"
            }
          }
        ]
      }
    },
    {
      "apiVersion": "2018-02-01",
      "type": "Microsoft.Network/routeTables",
      "name": "[variables('sub3SubnetRouteTable')]",
      "location": "[resourceGroup().location]",
      "tags": {
        "Environment": "Production",
        "Application": "BI Reports",
        "Function": "Networking",
        "Application Owner": "Tim Farrance",
        "Directorate": "Policy, Strategy and ICT",
        "Cost Centre": "11302"
      },
      "properties": {
        "routes": [
          {
            "name": "bcprdudrbirn001-production-to-tier1hub",
            "properties": {
              "addressPrefix": "0.0.0.0/0",
              "nextHopType": "VirtualAppliance",
              "nextHopIpAddress": "[variables('tier1fwtrustSubnetStartAddress')]"
            }
          }
        ]
      }
    },
    {
      "apiVersion": "2018-02-01",
      "type": "Microsoft.Network/routeTables",
      "name": "[variables('sub4SubnetRouteTable')]",
      "location": "[resourceGroup().location]",
      "tags": {
        "Environment": "Production",
        "Application": "Calm View",
        "Function": "Networking",
        "Application Owner": "Tim Farrance",
        "Directorate": "Policy, Strategy and ICT",
        "Cost Centre": "11302"
      },
      "properties": {
        "routes": [
          {
            "name": "bcprdudrcaln001-production-to-tier1hub",
            "properties": {
              "addressPrefix": "0.0.0.0/0",
              "nextHopType": "VirtualAppliance",
              "nextHopIpAddress": "[variables('tier1fwtrustSubnetStartAddress')]"
            }
          }
        ]
      }
    },
    {
      "apiVersion": "2018-02-01",
      "type": "Microsoft.Network/routeTables",
      "name": "[variables('sub5SubnetRouteTable')]",
      "location": "[resourceGroup().location]",
      "tags": {
        "Environment": "Production",
        "Application": "Information@Work",
        "Function": "Networking",
        "Application Owner": "Tim Farrance",
        "Directorate": "Policy, Strategy and ICT",
        "Cost Centre": "11302"
      },
      "properties": {
        "routes": [
          {
            "name": "bcprdudriawn001-prouction-to-tier1hub",
            "properties": {
              "addressPrefix": "0.0.0.0/0",
              "nextHopType": "VirtualAppliance",
              "nextHopIpAddress": "[variables('tier1fwtrustSubnetStartAddress')]"
            }
          }
        ]
      }
    },
    {
      "apiVersion": "2018-02-01",
      "type": "Microsoft.Network/routeTables",
      "name": "[variables('websub1SubnetRouteTable')]",
      "location": "[resourceGroup().location]",
      "tags": {
        "Environment": "Production",
        "Application": "Coroner's Portal",
        "Function": "Networking",
        "Application Owner": "Tim Farrance",
        "Directorate": "Policy, Strategy and ICT",
        "Cost Centre": "11302"
      },
      "properties": {
        "routes": [
          {
            "name": "bcprdudrcorn001-web-to-tier1hub",
            "properties": {
              "addressPrefix": "0.0.0.0/0",
              "nextHopType": "VirtualAppliance",
              "nextHopIpAddress": "[variables('tier1fwtrustSubnetStartAddress')]"
            }
          }
        ]
      }
    },
    {
      "apiVersion": "2018-02-01",
      "type": "Microsoft.Network/routeTables",
      "name": "[variables('secsub1SubnetRouteTable')]",
      "location": "[resourceGroup().location]",
      "tags": {
        "Environment": "Production",
        "Application": "Click Mobile",
        "Function": "Networking",
        "Application Owner": "Tim Farrance",
        "Directorate": "Policy, Strategy and ICT",
        "Cost Centre": "11302"
      },
      "properties": {
        "routes": [
          {
            "name": "bcprdudrclkn002-secure-to-tier1hub",
            "properties": {
              "addressPrefix": "0.0.0.0/0",
              "nextHopType": "VirtualAppliance",
              "nextHopIpAddress": "[variables('tier1fwtrustSubnetStartAddress')]"
            }
          }
        ]
      }
    },

    {
      "apiVersion": "2017-09-01",
      "type": "Microsoft.Network/publicIPAddresses",
      "name": "[concat(variables('fwNamePrefix'),copyIndex(1),'-pip-management')]",
      "location": "[resourceGroup().location]",
      "sku": {
        "name": "Standard"
      },
      "tags": {
        "Environment": "Production",
        "Application": "NVA-Firewall",
        "Function": "Networking",
        "Application Owner": "Tim Farrance",
        "Directorate": "Policy, Strategy and ICT",
        "Cost Centre": "11302"
      },
      "properties": {
        "publicIPAllocationMethod": "Static",
        "dnsSettings": {
          "domainNameLabel": "[concat('fw',copyIndex(1),'management', variables('uniqueId'))]"
        }

      },
      "copy": {

        "name": "managementPIPCopy",
        "count": "[variables('PACount')]"
      }
    },

    {

      "type": "Microsoft.Network/publicIPAddresses",
      "name": "[concat(variables('untrustLBName'),'-pip')]",
      "apiVersion": "2017-08-01",
      "location": "[resourceGroup().location]",
      "tags": {
        "Environment": "Production",
        "Application": "Azure Load Balancer",
        "Function": "Networking",
        "Application Owner": "Tim Farrance",
        "Directorate": "Policy, Strategy and ICT",
        "Cost Centre": "11302"
      },
      "sku": {
        "name": "Standard"
      },
      "properties": {
        "publicIPAllocationMethod": "Static",
        "idleTimeoutInMinutes": 4,
        "dnsSettings": {
          "domainNameLabel": "[concat('lbfw', variables('uniqueId'))]"
        }
      }
    },

    {
      "apiVersion": "2015-06-15",
      "type": "Microsoft.Network/networkInterfaces",
      "name": "[concat(variables('fwNamePrefix'),copyIndex(1),'-nic-management')]",
      "location": "[resourceGroup().location]",
      "tags": {
        "Environment": "Production",
        "Application": "NVA-Firewall",
        "Function": "Networking",
        "Application Owner": "Tim Farrance",
        "Directorate": "Policy, Strategy and ICT",
        "Cost Centre": "11302"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/publicIPAddresses', concat(variables('fwNamePrefix'),copyIndex(1),'-pip-management'))]",
        "[concat('Microsoft.Network/networkSecurityGroups/', 'bcprdnsgfwxx001')]"
      ],
      "properties": {
        "ipConfigurations": [
          {
            "name": "[concat(variables('fwNamePrefix'),copyIndex(1),'-nic-ipconfig-management')]",
            "properties": {
              "privateIPAllocationMethod": "Static",
              "privateIpAddress": "[concat(variables('tier1fwmgmtPrefix'),copyIndex(variables('tier1fwmgmtIPfirst')))]",
              "publicIPAddress": {
                "id": "[resourceId('Microsoft.Network/publicIPAddresses', concat(variables('fwNamePrefix'),copyIndex(1),'-pip-management'))]"
              },
              "subnet": {
                "id": "[variables('tier1fwmgmtSubnetRef')]"
              }
            }
          }
        ],
        "networkSecurityGroup": {
          "id": "[resourceId('Microsoft.Network/networkSecurityGroups', 'bcprdnsgfwxx001')]"
        }
      },
      "copy": {
        "name": "managementNICCopy",
        "count": "[variables('PACount')]"
      }
    },

    {
      "apiVersion": "2015-06-15",
      "type": "Microsoft.Network/networkInterfaces",
      "name": "[concat(variables('fwNamePrefix'),copyIndex(1),'-nic-untrust')]",
      "location": "[resourceGroup().location]",
      "tags": {
        "Environment": "Production",
        "Application": "NVA-Firewall",
        "Function": "Networking",
        "Application Owner": "Tim Farrance",
        "Directorate": "Policy, Strategy and ICT",
        "Cost Centre": "11302"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/loadBalancers', variables('untrustLBName'))]"
      ],
      "properties": {
        "enableIPForwarding": true,
        "ipConfigurations": [
          {
            "name": "[concat(variables('fwNamePrefix'),copyIndex(1),'-untrust')]",
            "properties": {
              "privateIPAllocationMethod": "Static",
              "privateIpAddress": "[concat(variables('tier1fwuntrustPrefix'),copyIndex(add(variables('tier1fwuntrustIPfirst'),1)))]",
              "subnet": {
                "id": "[variables('tier1fwuntrustSubnetRef')]"
              },
              "loadBalancerBackendAddressPools": [
                {
                  "id": "[concat(resourceId('Microsoft.Network/loadBalancers', variables('untrustLBName')), '/backendAddressPools/', 'untrustPool')]"
                }
              ]
            }
          }
        ]
      },

      "copy": {
        "name": "UntrustNICCopy",
        "count": "[variables('PACount')]"

      }

    },

    {

      "apiVersion": "2015-06-15",
      "type": "Microsoft.Network/networkInterfaces",
      "name": "[concat(variables('fwNamePrefix'),copyIndex(1),'-nic-trust')]",
      "location": "[resourceGroup().location]",
      "tags": {
        "Environment": "Production",
        "Application": "NVA-Firewall",
        "Function": "Networking",
        "Application Owner": "Tim Farrance",
        "Directorate": "Policy, Strategy and ICT",
        "Cost Centre": "11302"
      },

      "dependsOn": [
        "[resourceId('Microsoft.Network/loadBalancers', variables('fwILBName'))]"
      ],
      "properties": {
        "enableIPForwarding": true,
        "ipConfigurations": [
          {
            "name": "[concat(variables('fwNamePrefix'),copyIndex(1),'-trust')]",
            "properties": {
              "privateIPAllocationMethod": "Static",
              "privateIpAddress": "[concat(variables('tier1fwtrustPrefix'),copyIndex(add(variables('tier1fwtrustIPfirst'),1)))]",
              "subnet": {
                "id": "[variables('tier1fwtrustSubnetRef')]"
              },
              "loadBalancerBackendAddressPools": [
                {
                  "id": "[concat(resourceId('Microsoft.Network/loadBalancers', variables('fwILBName')), '/backendAddressPools/', 'trustpool')]"
                }
              ]
            }
          }
        ]
      },

      "copy": {
        "name": "TrustNICCopy",
        "count": "[variables('PACount')]"
      }
    },

    {
      "apiVersion": "2015-06-15",
      "type": "Microsoft.Network/networkInterfaces",
      "name": "[concat(variables('fwNamePrefix'),copyIndex(1),'-nic-bkhaul')]",
      "location": "[resourceGroup().location]",
      "tags": {
        "Environment": "Production",
        "Application": "NVA-Firewall",
        "Function": "Networking",
        "Application Owner": "Tim Farrance",
        "Directorate": "Policy, Strategy and ICT",
        "Cost Centre": "11302"
      },

      "dependsOn": [
        "[resourceId('Microsoft.Network/loadBalancers', variables('fwILBName'))]"
      ],
      "properties": {
        "enableIPForwarding": true,
        "ipConfigurations": [
          {
            "name": "[concat(variables('fwNamePrefix'),copyIndex(1),'-bkhaul')]",
            "properties": {
              "privateIPAllocationMethod": "Static",
              "privateIpAddress": "[concat(variables('tier1fwbkhaulPrefix'),copyIndex(add(variables('tier1fwbkhaulIPfirst'),1)))]",
              "subnet": {
                "id": "[variables('tier1fwbkhaulSubnetRef')]"
              },
              "loadBalancerBackendAddressPools": [
                {
                  "id": "[concat(resourceId('Microsoft.Network/loadBalancers', variables('fwILBName')), '/backendAddressPools/', 'bkhaulpool')]"
                }
              ]
            }
          }
        ]
      },

      "copy": {
        "name": "bkhaulNICCopy",
        "count": "[variables('PACount')]"
      }
    },

    {
      "apiVersion": "2017-03-30",
      "type": "Microsoft.Compute/virtualMachines",
      "name": "[concat(variables('fwNamePrefix'), copyIndex(1))]",
      "location": "[resourceGroup().location]",
      "tags": {
        "Environment": "Production",
        "Application": "NVA-Firewall",
        "Function": "Networking",
        "Application Owner": "Tim Farrance",
        "Directorate": "Policy, Strategy and ICT",
        "Cost Centre": "11302"
      },

      "plan": {
        "name": "[variables('PASku')]",
        "product": "vmseries1",
        "publisher": "paloaltonetworks"
      },
      "properties": {
        "availabilitySet": {
          "id": "[resourceId('Microsoft.Compute/availabilitySets', variables('availabilitySetName'))]"
        },
        "hardwareProfile": {
          "vmSize": "[variables('vmSize')]"
        },
        "osProfile": {
          "computerName": "[concat(variables('fwNamePrefix'),copyIndex(1))]",
          "adminUsername": "[parameters('paloAltoAdminName')]",
          "adminPassword": "[parameters('paloAltoAdminPassword')]"
        },
        "storageProfile": {
          "imageReference": {
            "publisher": "paloaltonetworks",
            "offer": "vmseries1",
            "sku": "[variables('PASku')]",
            "version": "[variables('PAVersion')]"
          },
          "osDisk": {
            "name": "[concat(variables('fwNamePrefix'),copyIndex(1),'-osdisk')]",
            "managedDisk": {
              "storageAccountType": "Premium_LRS"
            },
            "caching": "ReadWrite",
            "createOption": "FromImage"
          }
        },
        "networkProfile": {
          "networkInterfaces": [
            {
              "id": "[resourceId('Microsoft.Network/networkInterfaces', concat(variables('fwNamePrefix'),copyIndex(1),'-nic-management'))]",
              "properties": {
                "primary": true
              }
            },
            {
              "id": "[resourceId('Microsoft.Network/networkInterfaces', concat(variables('fwNamePrefix'),copyIndex(1),'-nic-untrust'))]",
              "properties": {
                "primary": false
              }
            },
            {
              "id": "[resourceId('Microsoft.Network/networkInterfaces', concat(variables('fwNamePrefix'),copyIndex(1),'-nic-trust'))]",
              "properties": {
                "primary": false
              }
            },
            {
              "id": "[resourceId('Microsoft.Network/networkInterfaces', concat(variables('fwNamePrefix'),copyIndex(1),'-nic-bkhaul'))]",
              "properties": {
                "primary": false
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/networkInterfaces', concat(variables('fwNamePrefix'),copyIndex(1),'-nic-management'))]",
        "[resourceId('Microsoft.Network/networkInterfaces', concat(variables('fwNamePrefix'),copyIndex(1),'-nic-untrust'))]",
        "[resourceId('Microsoft.Network/networkInterfaces', concat(variables('fwNamePrefix'),copyIndex(1),'-nic-trust'))]",
        "[resourceId('Microsoft.Compute/availabilitySets', variables('availabilitySetName'))]"
      ],
      "copy": {
        "name": "PAVMCopy",
        "count": "[variables('PACount')]"
      }
    },

    {
      "apiVersion": "2017-03-30",
      "type": "Microsoft.Compute/availabilitySets",
      "name": "[variables('availabilitySetName')]",
      "location": "[resourceGroup().location]",
      "tags": {
        "Environment": "Development",
        "Application": "Networking",
        "Function": "Hub Network Virtual Appliance",
        "Application Owner": "Tim Farrance",
        "Directorate": "Policy, Strategy and ICT",
        "Cost Centre": "11302"
      },

      "properties": {
        "platformUpdateDomainCount": 5,
        "platformFaultDomainCount": 2
      },
      "sku": {
        "name": "Aligned"
      }
    },
    {

      "type": "Microsoft.Network/loadBalancers",
      "name": "[variables('untrustLBName')]",
      "apiVersion": "2017-08-01",
      "location": "[resourceGroup().location]",
      "tags": {
        "Environment": "Production",
        "Application": "Azure Load Balancer",
        "Function": "Networking",
        "Application Owner": "Tim Farrance",
        "Directorate": "Policy, Strategy and ICT",
        "Cost Centre": "11302"
      },
      "sku": {
        "name": "Standard"
      },
      "properties": {
        "frontendIPConfigurations": [
          {
            "name": "[concat(variables('untrustLBName'),'-ipconfig-frontend')]",
            "properties": {
              "privateIPAllocationMethod": "Dynamic",
              "publicIPAddress": {
                "id": "[resourceId('Microsoft.Network/publicIPAddresses', concat(variables('untrustLBName'),'-pip'))]"
              }
            }
          }
        ],
        "backendAddressPools": [
          {
            "name": "untrustPool",
            "properties": {}
          }
        ],
        "loadBalancingRules": [
          {
            "name": "bcprdelbfwxn001-rule-untrust-port-80",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[concat(resourceId('Microsoft.Network/loadBalancers', variables('untrustLBName')), '/frontendIPConfigurations/', variables('untrustLBName'),'-ipconfig-frontend')]"
              },
              "frontendPort": 80,
              "backendPort": 80,
              "enableFloatingIP": false,
              "idleTimeoutInMinutes": 4,
              "protocol": "Tcp",
              "enableTcpReset": false,
              "loadDistribution": "SourceIP",
              "disableOutboundSnat": false,
              "backendAddressPool": {
                "id": "[concat(resourceId('Microsoft.Network/loadBalancers', variables('untrustLBName')), '/backendAddressPools/untrustPool')]"
              },
              "probe": {
                "id": "[concat(resourceId('Microsoft.Network/loadBalancers', variables('untrustLBName')), '/probes/bcprdelbfwxn001-probe-tcp-80')]"
              }
            }
          },
          {
            "name": "bcprdelbfwxn001-rule-untrust-port-443",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[concat(resourceId('Microsoft.Network/loadBalancers', variables('untrustLBName')), '/frontendIPConfigurations/', variables('untrustLBName'),'-ipconfig-frontend')]"
              },
              "frontendPort": 443,
              "backendPort": 443,
              "enableFloatingIP": false,
              "idleTimeoutInMinutes": 4,
              "protocol": "Tcp",
              "enableTcpReset": false,
              "loadDistribution": "SourceIP",
              "disableOutboundSnat": false,
              "backendAddressPool": {
                "id": "[concat(resourceId('Microsoft.Network/loadBalancers', variables('untrustLBName')), '/backendAddressPools/untrustPool')]"
              },
              "probe": {
                "id": "[concat(resourceId('Microsoft.Network/loadBalancers', variables('untrustLBName')), '/probes/bcprdelbfwxn001-probe-tcp-80')]"
              }
            }
          }
        ],
        "probes": [
          {
            "name": "bcprdelbfwxn001-probe-tcp-80",
            "properties": {
              "protocol": "Http",
              "port": 80,
              "requestPath": "/php/login.php",
              "intervalInSeconds": 5,
              "numberOfProbes": 2
            }
          }
        ],

        "inboundNatRules": [],
        "outboundNatRules": [],
        "inboundNatPools": []
      },
      "resources": [],
      "dependsOn": [
        "[resourceId('Microsoft.Network/publicIPAddresses', concat(variables('untrustLBName'),'-pip'))]"
      ]
    },
    {
      "type": "Microsoft.Network/loadBalancers",
      "name": "[variables('fwILBName')]",
      "apiVersion": "2017-08-01",
      "location": "[resourceGroup().location]",
      "tags": {
        "Environment": "Production",
        "Application": "Azure Load Balancer",
        "Function": "Networking",
        "Application Owner": "Tim Farrance",
        "Directorate": "Policy, Strategy and ICT",
        "Cost Centre": "11302"
      },
      "sku": {
        "name": "Standard"
      },
      "properties": {
        "frontendIPConfigurations": [
          {
            "name": "[concat(variables('fwILBName'),'-ipconfig-frontend-trust')]",
            "properties": {
              "privateIPAddress": "[concat(variables('tier1fwtrustPrefix'),variables('tier1fwtrustIPfirst'))]",
              "privateIPAllocationMethod": "Static",
              "subnet": {
                "id": "[variables('tier1fwtrustSubnetRef')]"
              },
              "privateIPAddressVersion": "IPv4"
            }
          },
          {
            "name": "[concat(variables('fwILBName'),'-ipconfig-frontend-bkhaul')]",
            "properties": {
              "privateIPAddress": "[concat(variables('tier1fwbkhaulPrefix'),variables('tier1fwbkhaulIPfirst'))]",
              "privateIPAllocationMethod": "Static",
              "subnet": {
                "id": "[variables('tier1fwbkhaulSubnetRef')]"
              },
              "privateIPAddressVersion": "IPv4"
            }
          }
        ],
        "backendAddressPools": [
          {
            "name": "trustPool",
            "properties": {}
          },
          {
            "name": "bkhaulPool",
            "properties": {}
          }
        ],
        "loadBalancingRules": [
          {
            "name": "bcprdilbfwxn001-rule-backhaul",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[concat(resourceId('Microsoft.Network/loadBalancers', variables('fwILBName')), '/frontendIPConfigurations/', variables('fwILBName'),'-ipconfig-frontend-bkhaul')]"
              },
              "frontendPort": 0,
              "backendPort": 0,
              "enableFloatingIP": true,
              "idleTimeoutInMinutes": 4,
              "protocol": "All",
              "enableTcpReset": false,
              "loadDistribution": "SourceIP",
              "disableOutboundSnat": false,
              "backendAddressPool": {
                "id": "[concat(resourceId('Microsoft.Network/loadBalancers', variables('fwILBName')), '/backendAddressPools/bkhaulPool')]"
              },
              "probe": {
                "id": "[concat(resourceId('Microsoft.Network/loadBalancers', variables('fwILBName')), '/probes/bcprdilbfwxn001-bkhaul-probe-tcp-80')]"
              }
            }
          },
          {
            "name": "bcprdilbfwxn001-rule-trust",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[concat(resourceId('Microsoft.Network/loadBalancers', variables('fwILBName')), '/frontendIPConfigurations/', variables('fwILBName'),'-ipconfig-frontend-trust')]"
              },
              "frontendPort": 0,
              "backendPort": 0,
              "enableFloatingIP": false,
              "idleTimeoutInMinutes": 4,
              "protocol": "All",
              "enableTcpReset": false,
              "loadDistribution": "SourceIP",
              "disableOutboundSnat": false,
              "backendAddressPool": {
                "id": "[concat(resourceId('Microsoft.Network/loadBalancers', variables('fwILBName')), '/backendAddressPools/trustPool')]"
              },
              "probe": {
                "id": "[concat(resourceId('Microsoft.Network/loadBalancers', variables('fwILBName')), '/probes/bcprdilbfwxn001-trust-probe-tcp-80')]"
              }
            }
          }
        ],
        "probes": [
          {
            "name": "bcprdilbfwxn001-bkhaul-probe-tcp-80",
            "properties": {
              "protocol": "Http",
              "port": 80,
              "requestPath": "/php/login.php",
              "intervalInSeconds": 5,
              "numberOfProbes": 2
            }
          },
          {
            "name": "bcprdilbfwxn001-trust-probe-tcp-80",
            "properties": {
              "protocol": "Http",
              "port": 80,
              "requestPath": "/php/login.php",
              "intervalInSeconds": 5,
              "numberOfProbes": 2
            }
          }
        ],
        "inboundNatRules": [],
        "outboundNatRules": [],
        "inboundNatPools": []
      },
      "resources": [],
      "dependsOn": [
        "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworkNameTier1Hub'))]"
      ]
    },

    {

      "apiVersion": "2017-08-01",
      "type": "Microsoft.Network/publicIPAddresses",
      "name": "[variables('erGatewayPublicIPName')]",
      "location": "[resourceGroup().location]",
      "tags": {
        "Environment": "Production",
        "Application": "ER Gateway PIP",
        "Function": "Networking",
        "Application Owner": "Tim Farrance",
        "Directorate": "Policy, Strategy and ICT",
        "Cost Centre": "11302"
      },
      "properties": {
        "publicIPAllocationMethod": "Dynamic"
      }
    },

    {

      "apiVersion": "2019-04-01",
      "type": "Microsoft.Network/virtualNetworkGateways",
      "name": "[variables('erGatewayName')]",
      "location": "[resourceGroup().location]",
      "tags": {
        "Environment": "Production",
        "Application": "Azure ER Gateway",
        "Function": "Production Virtual Network",
        "Application Owner": "Tim Farrance",
        "Directorate": "Policy, Strategy and ICT",
        "Cost Centre": "11302"
      },
      "dependsOn": [
        "[concat('Microsoft.Network/publicIPAddresses/', variables('erGatewayPublicIPName'))]",
        "[concat('Microsoft.Network/virtualNetworks/', variables('virtualNetworkNameTier1Hub'))]"
      ],
      "properties": {
        "ipConfigurations": [
          {
            "properties": {
              "privateIPAllocationMethod": "Dynamic",
              "subnet": {
                "id": "[variables('tier1gwSubnetRef')]"
              },

              "publicIPAddress": {
                "id": "[resourceId('Microsoft.Network/publicIPAddresses',variables('ergatewayPublicIPName'))]"
              }
            },

            "name": "vnetGatewayConfig"
          }
        ],

        "gatewayType": "[variables('erGatewayType')]"
      }
    },

    {

      "apiVersion": "2019-02-01",
      "name": "[variables('erConnectionName')]",
      "type": "Microsoft.Network/connections",
      "location": "[resourceGroup().location]",
      "tags": {
        "Environment": "Production",
        "Application": "Azure ER Connection",
        "Function": "Production Virtual Network",
        "Application Owner": "Tim Farrance",
        "Directorate": "Policy, Strategy and ICT",
        "Cost Centre": "11302"
      },
      "dependsOn": [
        "[concat('Microsoft.Network/virtualnetworkgateways/', variables('erGatewayName'))]"
      ],
      "properties": {
        "virtualNetworkGateway1": {
          "id": "[resourceId('Microsoft.Network/virtualnetworkgateways', variables('erGatewayName'))]"
        },
        "peer": {
          "id": "/subscriptions/227152d7-5195-4431-bf3d-f1744cf9de51/resourceGroups/bcprdrgpnetx002/providers/Microsoft.Network/expressRouteCircuits/bcprdexrxxxx002"
        },
        "connectionType": "[variables('erConnectionType')]",
        "routingWeight": "[variables('routingWeight')]"
      }
    },

    {

      "apiVersion": "2017-08-01",
      "type": "Microsoft.Network/publicIPAddresses",
      "name": "[variables('vpnGatewayPublicIPName')]",
      "location": "[resourceGroup().location]",
      "tags": {
        "Environment": "Production",
        "Application": "Azure Gateway PIP",
        "Function": "Networking",
        "Application Owner": "Tim Farrance",
        "Directorate": "Policy, Strategy and ICT",
        "Cost Centre": "11302"
      },
      "dependsOn": [
        "[concat('Microsoft.Network/virtualNetworks/', variables('virtualNetworkNameTier1Hub'))]",
        "[concat('Microsoft.Network/virtualNetworkGateways/', variables('erGatewayName'))]",
        "[concat('Microsoft.Network/publicIPAddresses/', variables('erGatewayPublicIPName'))]"
      ],
      "properties": {
        "publicIPAllocationMethod": "Dynamic"
      }
    },

    {

      "apiVersion": "2019-04-01",
      "type": "Microsoft.Network/virtualNetworkGateways",
      "name": "[variables('vpnGatewayName')]",
      "location": "[resourceGroup().location]",
      "tags": {
        "Environment": "Production",
        "Application": "Azure VPN Gateway",
        "Function": "Networking",
        "Application Owner": "Tim Farrance",
        "Directorate": "Policy, Strategy and ICT",
        "Cost Centre": "11302"
      },
      "dependsOn": [
        "[concat('Microsoft.Network/virtualNetworks/', variables('virtualNetworkNameTier1Hub'))]",
        "[concat('Microsoft.Network/virtualNetworkGateways/', variables('erGatewayName'))]",
        "[concat('Microsoft.Network/publicIPAddresses/', variables('erGatewayPublicIPName'))]",
        "[concat('Microsoft.Network/publicIPAddresses/', variables('vpnGatewayPublicIPName'))]"
      ],

      "properties": {
        "ipConfigurations": [
          {
            "properties": {
              "privateIPAllocationMethod": "Dynamic",
              "subnet": {
                "id": "[variables('tier1gwSubnetPrefix')]"
              },
              "publicIPAddress": {
                "id": "[resourceId('Microsoft.Network/publicIPAddresses',variables('vpnGatewayPublicIPName'))]"
              }
            },
            "name": "vnetGatewayConfig"
          }
        ],
        "sku": {
          "name": "[variables('vpnGatewaySku')]",
          "tier": "[variables('vpnGatewaySku')]"
        },

        "gatewayType": "Vpn",
        "vpnType": "[variables('vpnType')]",
        "enableBgp": "false"
      }

    },

    {

      "apiVersion": "2019-09-01",
      "type": "Microsoft.Network/localNetworkGateways",
      "name": "[variables('localGatewayName')]",
      "location": "[resourceGroup().location]",
      "tags": {
        "Environment": "Production",
        "Application": "Azure OnPrem Gateway",
        "Function": "Networking",
        "Application Owner": "Tim Farrance",
        "Directorate": "Policy, Strategy and ICT",
        "Cost Centre": "11302"
      },
      "dependsOn": [
        "[concat('Microsoft.Network/virtualNetworks/', variables('virtualNetworkNameTier1Hub'))]",
        "[concat('Microsoft.Network/virtualNetworkGateways/', variables('erGatewayName'))]",
        "[concat('Microsoft.Network/publicIPAddresses/', variables('erGatewayPublicIPName'))]"
      ],
      "properties": {
        "localNetworkAddressSpace": {
          "addressPrefixes": [
            "[variables('localAddressPrefixes')]"
          ]
        },
        "gatewayIpAddress": "[variables('localGatewayIPAddress')]"
      }
    },

    {

      "apiVersion": "2019-09-01",
      "name": "[variables('vpnConnectionName')]",
      "type": "Microsoft.Network/connections",
      "location": "[resourceGroup().location]",
      "tags": {
        "Environment": "Production",
        "Application": "Azure VPN connection",
        "Function": "Networking",
        "Application Owner": "Tim Farrance",
        "Directorate": "Policy, Strategy and ICT",
        "Cost Centre": "11302"
      },
      "dependsOn": [
        "[concat('Microsoft.Network/virtualNetworks/', variables('virtualNetworkNameTier1Hub'))]",
        "[concat('Microsoft.Network/virtualNetworkGateways/', variables('erGatewayName'))]",
        "[concat('Microsoft.Network/publicIPAddresses/', variables('erGatewayPublicIPName'))]",
        "[concat('Microsoft.Network/virtualNetworkGateways/', variables('vpngatewayName'))]",
        "[concat('Microsoft.Network/localNetworkGateways/', variables('localGatewayName'))]",
        "[concat('Microsoft.Network/publicIPAddresses/', variables('vpnGatewayPublicIPName'))]"
      ],

      "properties": {
        "virtualNetworkGateway1": {
          "id": "[resourceId('Microsoft.Network/virtualNetworkGateways', variables('vpnGatewayName'))]"
        },

        "localNetworkGateway2": {
          "id": "[resourceId('Microsoft.Network/localNetworkGateways', variables('localGatewayName'))]"
        },

        "connectionType": "[variables('vpnConnectionType')]",
        "routingWeight": "[variables('routingWeight')]",
        "sharedKey": "[parameters('vpnSharedkey')]"
      }
    }
  ],
  "outputs": {}
}